<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Portfolio Analyzer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Portfolio Analyzer">
    <meta name="description" content="Professional portfolio analysis with multi-source market data">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <!-- Icons for PWA -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text y='.9em' font-size='50' fill='white'>📊</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text y='.9em' font-size='50' fill='white'>📊</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles and Scripts -->
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Portfolio Analysis Dashboard</h1>
            <div class="last-update">Last updated: <span id="lastUpdate">-</span></div>
        </header>
        
        <!-- Control Panel -->
        <section class="controls">
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
            <button onclick="document.getElementById('csvFile').click()">
                Upload Transaction CSV
            </button>
            <div class="sample-downloads">
                <button onclick="downloadSample('transactions')" class="sample-link" title="Download CSV template for transaction data upload">
                    📄 Download Transaction CSV Template
                </button>
                <div class="format-info">
                    💡 Upload your transaction history (BUY/SELL records) for accurate portfolio calculation
                </div>
            </div>
            <!-- SIMPLIFIED WORKFLOW BUTTONS -->
            <div class="workflow-step" id="step1">
                <h3>Step 1: Upload Transactions</h3>
                <p>Upload your transaction CSV to see your positions and cost basis</p>
            </div>
            
            <div class="workflow-step" id="step2" style="display: none;">
                <h3>Step 2: Batch Job Management & Prices</h3>
                <button onclick="triggerBatchJob()" style="background: linear-gradient(45deg, #17a2b8, #138496);">
                    🔄 Run Batch Job
                </button>
                <button onclick="refreshPricesDisplay()" style="background: linear-gradient(45deg, #28a745, #1e7e34); margin-left: 10px;">
                    💹 Show Prices
                </button>
                <p>Run batch job to fetch prices, then view current prices</p>
            </div>
            
            <div class="additional-actions" style="margin-top: 20px; display: none;" id="additionalActions">
                <button onclick="toggleAddHoldingForm()" id="addHoldingBtn">
                    Add New Transaction
                </button>
                <button onclick="exportData()">
                    Export Analysis
                </button>
                <button onclick="triggerBatchJob()" style="background: linear-gradient(45deg, #17a2b8, #138496);">
                    🔄 Run Batch Job
                </button>
                <button onclick="clearPortfolio()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                    Clear Portfolio
                </button>
            </div>
        </section>
        
        <!-- Add Holding Form -->
        <section class="add-holding-form" id="addHoldingForm" style="display: none;">
            <h2>Add New Transaction</h2>
            <form id="holdingForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ticker">Ticker Symbol *</label>
                        <input type="text" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
                    </div>
                    <div class="form-group">
                        <label for="exchange">Exchange</label>
                        <select id="exchange" name="exchange">
                            <option value="NASDAQ">NASDAQ</option>
                            <option value="NYSE">NYSE</option>
                            <option value="AMEX">AMEX</option>
                            <option value="LSE">London Stock Exchange</option>
                            <option value="TSE">Tokyo Stock Exchange</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionType">Transaction Type *</label>
                        <select id="transactionType" name="transactionType" required onchange="toggleTransactionFields()">
                            <option value="BUY">BUY - Purchase shares</option>
                            <option value="SELL">SELL - Sell shares</option>
                            <option value="DIVIDEND">DIVIDEND - Dividend payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tradeDate">Trade Date *</label>
                        <input type="date" id="tradeDate" name="tradeDate" required>
                    </div>
                </div>
                
                <div class="form-row" id="shareFields">
                    <div class="form-group">
                        <label for="quantity">Quantity (Shares) *</label>
                        <input type="number" id="quantity" name="quantity" step="0.001" placeholder="100" required>
                    </div>
                    <div class="form-group">
                        <label for="price">Price per Share *</label>
                        <input type="number" id="price" name="price" step="0.01" placeholder="150.00" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">Total Amount *</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="15000.00" required>
                        <small>Total transaction value (quantity × price)</small>
                    </div>
                    <div class="form-group">
                        <label for="fees">Transaction Fee</label>
                        <input type="number" id="fees" name="fees" step="0.01" placeholder="9.95" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currency">Currency</label>
                        <select id="currency" name="currency">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conversionNote" style="font-size: 0.8em; color: #888;">
                            📊 Will be converted to USD for analysis
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Add Transaction</button>
                    <button type="button" onclick="toggleAddHoldingForm()" class="btn-secondary">Cancel</button>
                </div>
            </form>
        </section>
        
        <!-- Current Holdings Management -->
        <section class="holdings-management" id="holdingsManagement" style="display: none;">
            <h2>Current Holdings</h2>
            <div class="holdings-list" id="holdingsList">
                <p>No holdings found. Add your first holding using the form above.</p>
            </div>
        </section>
        
        <!-- Summary Cards -->
        <section class="summary-cards">
            <div class="card">
                <h3>Total Investment</h3>
                <div class="value" id="totalValue">$0</div>
                <small class="card-note">Cost basis from transactions</small>
            </div>
            <div class="card">
                <h3>Total Return</h3>
                <div class="value" id="totalReturn">Run batch job for prices</div>
                <small class="card-note">Requires batch job price data</small>
            </div>
            <div class="card">
                <h3>Return %</h3>
                <div class="value" id="returnPct">Run batch job for prices</div>
                <small class="card-note">Requires batch job price data</small>
            </div>
            <div class="card">
                <h3>Holdings</h3>
                <div class="value" id="holdingsCount">0</div>
                <small class="card-note">Number of positions</small>
            </div>
        </section>
        
        <!-- Recommendations Table -->
        <section class="recommendations">
            <h2>ML Recommendations</h2>
            <div class="recommendation-info" id="recommendationInfo" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; font-size: 14px;">
                Choose your analysis method: <strong>Statistical ML</strong> uses transaction-based portfolio analysis and smart modeling, or <strong>Live Data + ML</strong> includes real market sentiment and news.
            </div>
            <div class="table-container">
                <table id="recommendationsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Value</th>
                            <th>Return</th>
                            <th>Recommendation</th>
                            <th>Action</th>
                            <th>Rationale</th>
                        </tr>
                    </thead>
                    <tbody id="recommendationsBody">
                        <tr><td colspan="6">Upload portfolio and choose your ML analysis method above</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Charts -->
        <section class="charts">
            <div class="chart-container">
                <h2>Portfolio Allocation</h2>
                <canvas id="allocationChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>Performance by Stock</h2>
                <canvas id="performanceChart"></canvas>
            </div>
        </section>
    </div>
    
    <!-- PWA Installation Banner -->
    <div id="installBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--primary-color); color: white; padding: 1rem; text-align: center; z-index: 1000;">
        <div style="display: flex; align-items: center; justify-content: space-between; max-width: 600px; margin: 0 auto;">
            <span>📱 Install Portfolio Analyzer for better experience!</span>
            <div>
                <button id="installBtn" style="background: white; color: var(--primary-color); border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-right: 0.5rem; cursor: pointer;">Install</button>
                <button id="dismissBtn" style="background: transparent; color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Dismiss</button>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('✅ SW registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        console.log('🔄 SW update found');
                    });
                    
                } catch (error) {
                    console.error('❌ SW registration failed:', error);
                }
            });
            
            // Handle PWA install prompt
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBanner').style.display = 'block';
            });
            
            document.getElementById('installBtn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('PWA install outcome:', outcome);
                    deferredPrompt = null;
                    document.getElementById('installBanner').style.display = 'none';
                }
            });
            
            document.getElementById('dismissBtn').addEventListener('click', () => {
                document.getElementById('installBanner').style.display = 'none';
            });
            
            // Handle app shortcuts from PWA
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'add') {
                // Auto-open add transaction form
                setTimeout(() => {
                    const addBtn = document.getElementById('addHoldingBtn');
                    if (addBtn) addBtn.click();
                }, 1000);
            } else if (action === 'market') {
                // Auto-fetch market data
                setTimeout(() => {
                    if (typeof fetchMarketData === 'function') {
                        fetchMarketData();
                    }
                }, 1000);
            }
        }
    </script>
</body>
</html>